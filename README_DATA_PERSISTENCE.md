# 数据持久化说明

## 数据存储机制

本系统使用浏览器的 **localStorage** 进行数据持久化存储，确保用户数据在以下情况下不会丢失：

### ✅ 数据持久化保障

1. **用户数据隔离**
   - 每个用户的数据通过用户ID（`userId`）进行隔离存储
   - 文件数据存储在 `blockchain-storage-files` 键下，格式：`{ userId: [文件列表] }`
   - 用户信息存储在 `blockchain-storage-users` 键下

2. **数据持久化特性**
   - ✅ 关闭浏览器后数据仍然保留
   - ✅ 刷新页面后数据仍然保留
   - ✅ 重新登录后数据仍然保留
   - ✅ 数据按用户ID隔离，不同用户的数据互不干扰

3. **数据存储内容**
   - 用户账户信息（用户名、密码哈希、头像、公钥、角色等）- **永久保存**
   - 用户个人信息（头像、用户名、公钥等）- **永久保存，下次登录依然存在**
   - 用户上传的所有文件（文件名、大小、内容、上传时间等）- **永久保存**
   - 文件元数据（哈希值、区块链交易ID、状态等）- **永久保存**

### 🔒 数据安全

- 密码使用 SHA256 哈希存储，不会明文保存
- 文件内容以 Base64 格式存储
- 每个用户只能访问自己的数据
- 个人信息（头像、用户名、公钥等）永久保存，不会丢失

### 💾 个人信息持久化

**个人信息永久保存机制：**

1. **登录时保存**
   - 登录成功后，所有个人信息（头像、用户名、公钥、角色等）立即保存到 localStorage
   - 保存后立即验证，确保数据写入成功

2. **更新时保存**
   - 修改个人信息时，同时更新用户数据库和 localStorage
   - 更新后立即验证保存状态
   - 触发全局更新事件，确保所有组件显示最新信息

3. **下次登录恢复**
   - 登录时从用户数据库加载最新的个人信息
   - 自动同步到 localStorage
   - 确保所有个人信息字段完整恢复

4. **数据验证**
   - 每次保存后验证数据完整性
   - 保存失败时给出明确错误提示
   - 防止数据丢失

### ⚠️ 注意事项

1. **浏览器存储限制**
   - localStorage 通常有 5-10MB 的存储限制
   - 如果存储空间不足，系统会提示错误信息

2. **清除浏览器数据**
   - 如果用户清除浏览器缓存或 localStorage，数据会丢失
   - 建议定期备份重要文件

3. **多设备同步**
   - 当前版本数据存储在本地浏览器，不支持多设备同步
   - 如需多设备访问，需要每个设备单独登录并上传文件

### 📊 数据验证

系统在每次写入数据后都会验证写入是否成功，确保数据完整性。

### 🔄 数据恢复

如果遇到数据丢失问题：
1. 检查浏览器是否清除了 localStorage
2. 检查是否有多个浏览器标签页同时操作导致冲突
3. 尝试刷新页面重新加载数据

