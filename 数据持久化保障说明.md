# 数据持久化保障说明

## 📋 概述

本系统已实现完善的数据持久化机制，确保**修改网页源代码不会影响已注册用户的状态和存储的文件数据**。

---

## ✅ 数据保护机制

### 1. **稳定的存储键名**

系统使用固定的存储键名，不会因代码更新而改变：

- **用户数据**：`blockchain-storage-users`
- **文件数据**：`blockchain-storage-files`
- **当前用户信息**：`userInfo`
- **数据版本**：`blockchain-storage-version`

这些键名在代码中定义为常量，确保稳定性。

### 2. **数据版本管理**

- 系统维护数据版本号，每次数据结构变更时递增
- 应用启动时自动检测版本差异
- 自动执行数据迁移，确保旧数据兼容新代码

### 3. **自动数据迁移**

- **版本检测**：启动时检查数据版本
- **自动备份**：迁移前自动备份所有数据
- **数据验证**：迁移后验证数据完整性
- **错误恢复**：迁移失败时自动从备份恢复

### 4. **数据隔离**

- 每个用户的数据通过用户ID隔离存储
- 文件数据按用户ID分组：`{ userId: [文件列表] }`
- 不同用户的数据互不干扰

---

## 🔒 数据持久化特性

### ✅ 以下情况数据不会丢失：

1. **代码更新**
   - 修改源代码并重新部署
   - 更新依赖包
   - 修改 UI 组件
   - 添加新功能

2. **浏览器操作**
   - 关闭浏览器后重新打开
   - 刷新页面
   - 清除缓存（注意：清除 localStorage 会删除数据）

3. **用户操作**
   - 重新登录
   - 切换用户
   - 修改个人信息

4. **系统更新**
   - 数据结构版本升级
   - 功能模块更新
   - 安全补丁更新

---

## 💾 存储的数据类型

### 用户账户数据（永久保存）

- 用户名
- 密码哈希（SHA256）
- 昵称
- 头像（Base64 或 URL）
- 公钥
- 角色
- 创建时间

**存储位置**：`blockchain-storage-users`

### 用户文件数据（永久保存）

- 文件名
- 文件大小
- 文件内容（Base64）
- 文件哈希
- 区块链交易ID
- 上传时间
- 文件状态
- 文件类型
- 文件描述

**存储位置**：`blockchain-storage-files`（按用户ID分组）

### 当前会话数据

- 当前登录用户信息
- 登录令牌

**存储位置**：`userInfo`、`token`

---

## 🛡️ 数据安全保护

### 1. **自动备份机制**

- 数据迁移前自动创建备份
- 保留最近 3 个备份
- 备份键名格式：`{原键名}-backup-{时间戳}`

### 2. **数据验证**

- 启动时验证数据格式
- 检测数据完整性
- 发现异常时自动恢复

### 3. **错误处理**

- 所有存储操作都有错误处理
- 存储失败时记录错误日志
- 提供用户友好的错误提示

### 4. **向后兼容**

- 新代码能读取旧版本数据
- 自动迁移旧数据格式
- 保持数据完整性

---

## 🔄 数据迁移流程

### 启动时自动执行：

1. **检查版本**
   ```
   当前版本 ≠ 存储版本 → 需要迁移
   ```

2. **验证数据**
   ```
   检查数据格式是否正确
   ```

3. **创建备份**
   ```
   备份所有用户数据和文件数据
   ```

4. **执行迁移**
   ```
   根据版本差异执行相应的迁移逻辑
   ```

5. **更新版本**
   ```
   更新存储的版本号
   ```

6. **验证结果**
   ```
   验证迁移后的数据完整性
   ```

---

## 📝 开发者注意事项

### ✅ 可以安全修改的内容：

- UI 组件和样式
- 业务逻辑代码
- 路由配置
- 新增功能模块
- 依赖包更新

### ⚠️ 需要谨慎修改的内容：

- **存储键名**：如需修改，必须添加迁移逻辑
- **数据结构**：修改后需要更新版本号并添加迁移逻辑
- **数据格式**：确保向后兼容

### 🔧 如何添加新的数据迁移：

1. 在 `api/dataMigration.ts` 中增加 `DATA_VERSION`
2. 在 `migrateData` 函数中添加迁移逻辑
3. 测试迁移过程
4. 确保向后兼容

---

## 🧪 测试数据持久化

### 测试步骤：

1. **注册用户并上传文件**
   ```bash
   # 在浏览器中注册用户，上传一些文件
   ```

2. **修改源代码**
   ```bash
   # 修改任意代码文件（如样式、组件等）
   ```

3. **重新构建和部署**
   ```bash
   npm run build
   # 部署到服务器
   ```

4. **验证数据**
   ```bash
   # 重新打开网页，登录
   # 检查：用户信息、文件列表是否完整
   ```

### 预期结果：

- ✅ 用户信息完整保留
- ✅ 所有文件数据完整保留
- ✅ 用户状态正常（已登录）
- ✅ 文件可以正常下载

---

## 🚨 重要提醒

### ⚠️ 会丢失数据的情况：

1. **清除浏览器数据**
   - 清除 localStorage 会删除所有数据
   - 建议用户定期导出重要数据

2. **更换浏览器**
   - localStorage 是浏览器本地存储
   - 不同浏览器的数据不共享

3. **使用隐私/无痕模式**
   - 关闭窗口后数据会被清除

### 💡 建议：

- 定期备份重要数据
- 考虑添加数据导出功能
- 未来可考虑云端同步

---

## 📊 数据统计

系统提供数据统计功能（用于调试）：

```typescript
import { getDataStats } from './api/dataMigration'

const stats = getDataStats()
console.log(stats)
// {
//   version: 1,
//   userCount: 5,
//   totalFiles: 23,
//   hasUserInfo: true,
//   storageSize: 1234567
// }
```

---

## 🔍 故障排查

### 问题：数据丢失

**检查步骤：**

1. 打开浏览器开发者工具
2. 查看 Application → Local Storage
3. 检查是否存在以下键：
   - `blockchain-storage-users`
   - `blockchain-storage-files`
   - `userInfo`

4. 如果存在备份，可以手动恢复：
   ```javascript
   // 在控制台执行
   const backup = localStorage.getItem('blockchain-storage-users-backup-1234567890')
   if (backup) {
     localStorage.setItem('blockchain-storage-users', backup)
   }
   ```

### 问题：迁移失败

**解决方案：**

1. 检查浏览器控制台错误信息
2. 查看是否有备份数据
3. 手动从备份恢复（见上方代码）
4. 联系开发者获取支持

---

## 📚 相关文件

- `api/dataMigration.ts` - 数据迁移和版本管理
- `api/auth.ts` - 用户认证和数据存储
- `api/storage.ts` - 文件存储管理
- `main.ts` - 应用启动和数据迁移初始化

---

## ✅ 总结

**系统已完全保障数据持久化，你可以放心修改源代码，已注册用户的数据和文件不会丢失！**

- ✅ 稳定的存储键名
- ✅ 自动数据迁移
- ✅ 自动备份机制
- ✅ 数据验证和恢复
- ✅ 向后兼容

**修改代码 → 重新部署 → 用户数据完整保留！** 🎉

